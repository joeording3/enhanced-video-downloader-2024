# Enhanced Video Downloader Extension Overview

## Test Organization

The extension follows a structured test organization that separates unit tests from integration
tests:

### Unit Tests (Centralized in Source)

Unit tests are organized in a centralized `__tests__` directory for better maintainability:

```text
extension/src/
├── __tests__/                    # Centralized unit tests
│   ├── background-logic.test.ts
│   ├── background-helpers.test.ts
│   ├── background-queue.test.ts
│   ├── stryker-test.test.ts
│   ├── youtube_enhance.test.ts
│   ├── core/                     # Core module unit tests
│   │   ├── dom-manager.test.ts
│   │   ├── validation-service.test.ts
│   │   └── dom-manager.integration.test.ts
│   └── lib/                      # Library module unit tests
│       ├── event-manager.test.ts
│       ├── performance-utils.test.ts
│       └── utils.test.ts
```

### Integration Tests (Separate Directory)

Integration tests are kept in a separate directory for comprehensive testing:

```text
tests/extension/                  # Integration tests
├── background.test.ts            # Comprehensive integration
├── background-simple.test.ts     # Simple integration
├── background.util.test.ts       # Utility integration
├── content.behavior.test.ts      # UI behavior
├── content.extra.test.ts         # Edge cases
├── content.state.test.ts         # State management
├── content.test.ts               # Core functionality
├── content.ui.test.ts            # UI components
├── content.util.test.ts          # Utility functions
├── popup.*.test.ts              # Popup functionality
├── options.*.test.ts            # Options functionality
├── history.*.test.ts            # History functionality
└── playwright-e2e.spec.js       # E2E testing
```

### Configuration

The Jest configuration supports both test locations:

- `extension/src/__tests__/**/*.test.ts` - Unit tests
- `tests/extension/**/*.test.ts` - Integration tests

### Build Artifacts

The `extension-instrumented/` directory contains only compiled JavaScript files for testing
frameworks:

- **Source Files**: Compiled TypeScript source files
- **No Test Files**: Test files are kept in source directories, not compiled
- **Testing Support**: Used by Jest and Stryker for mutation testing
- **Generated Only**: This directory is generated by TypeScript compilation

### Test Strategy

#### **Unit Tests** (`extension/src/__tests__/`)

- Test individual functions and modules
- Fast execution and isolated testing
- Co-located with source code
- Organized by module (core/, lib/)

#### **Integration Tests** (`tests/extension/`)

- Test multiple components working together
- Test UI interactions and behaviors
- Test end-to-end workflows
- Test Chrome API integrations

### Running Tests

```bash
# Run unit tests only
npm test -- --testPathPattern="extension/src"

# Run integration tests only
npm test -- --testPathPattern="tests/extension"

# Run all tests
npm test
```

### Avoiding Duplication

- **Unit tests** should only exist in `extension/src/__tests__/`
- **Integration tests** should only exist in `tests/extension/`
- Each test should have a clear, unique purpose
- Avoid testing the same functionality in both unit and integration tests

## Enhanced Video Downloader TypeScript Refactoring

This directory contains the TypeScript source files for the Enhanced Video Downloader extension.

## Structure

- `types/` - Type definitions for the application
  - `index.ts` - Shared interfaces (ButtonState, DownloadOptions, HistoryEntry, etc.)
  - `chrome.d.ts` - Chrome extension API typings
- `core/` - Core architecture modules
  - `constants.ts` - Centralized constants and configuration (includes port functions)
  - `dom-manager.ts` - DOM manipulation and video element management
  - `error-handler.ts` - Centralized error handling and logging
  - `logger.ts` - Centralized logging system
  - `state-manager.ts` - State management for UI and extension state
  - `validation-service.ts` - Input validation and sanitization
- `lib/` - Shared utility functions and helpers
  - `utils.ts` - General utilities (debounce, logging, etc.)
  - `performance-utils.ts` - Performance monitoring and optimization
  - `event-manager.ts` - Event handling and management
- `__tests__/` - TypeScript test files
  - `background-logic.test.ts` - Background script logic tests
  - `background-queue.test.ts` - Download queue management tests
  - `background-helpers.test.ts` - Background helper utilities tests
  - `youtube_enhance.test.ts` - YouTube enhancement tests
  - `stryker-test.test.ts` - Mutation testing setup
- `global.d.ts` - Global type declarations for Chrome APIs and testing
- `background.ts` - Background script (port discovery, server communication)
- `background-helpers.ts` - Utilities for the background script
- `background-logic.ts` - Core background script business logic
- `content.ts` - Content script (button injection, video discovery)
- `youtube_enhance.ts` - YouTube-specific enhancements
- `popup.ts` - Popup UI page
- `options.ts` - Options page UI
- `history.ts` - History management and UI
- `stryker-test.ts` - Mutation testing entry point

## Completed Work

- [x] Set up TypeScript configuration (`tsconfig.json`)
- [x] Create shared type definitions
- [x] Implement utility modules with proper types
- [x] Convert `youtube_enhance.js` to TypeScript
- [x] Convert `background.js` to TypeScript
- [x] Convert `content.js` to TypeScript
- [x] Set up ESLint for TypeScript
- [x] Configure build process with esbuild
- [x] Set up Jest for TypeScript testing
- [x] Create initial TypeScript tests for utilities
- [x] **Convert `popup.js` to TypeScript**
- [x] **Convert `options.js` to TypeScript**
- [x] **Convert `history.js` to TypeScript**
- [x] **Implement core architecture modules**
  - [x] Centralized constants system (including port functions)
  - [x] State management system
  - [x] Error handling system
  - [x] Logging system
  - [x] DOM management system
  - [x] Validation service
- [x] **Extract background logic into separate module**
- [x] **Create TypeScript test infrastructure**
- [x] **Complete migration of legacy constants to core/constants.ts**
- [x] **Convert all existing JavaScript tests to TypeScript**
- [x] **Update documentation with TypeScript examples**
- [x] **Remove legacy JavaScript files after full migration** (Core files migrated, E2E tests remain
      as JS)

## Remaining Work

- [ ] Expand test coverage to meet 80% threshold (currently 64.18% statements, 48.23% branches)

## Build Process

The TypeScript files are compiled and bundled into the `extension/dist` directory using esbuild. The
process:

1. TypeScript type checking via `tsc`
2. Bundle and transform with esbuild
3. Output ES modules to `extension/dist/`

During development, the original JavaScript files are copied to `dist/` as a fallback.

## Testing

Tests are run using Jest with TypeScript support:

```bash
# Run all tests (TypeScript and JavaScript)
npm test

# Run tests with coverage
npm run test:coverage

# Run tests in watch mode
npm run test:watch
```

**Current Test Status**: 33 test suites, 482 tests passing

## Core Architecture

The extension now uses a modular core architecture:

- **Constants**: Centralized configuration in `core/constants.ts` (includes port functions)
- **State Management**: Centralized state in `core/state-manager.ts`
- **Error Handling**: Centralized error handling in `core/error-handler.ts`
- **Logging**: Centralized logging in `core/logger.ts`
- **DOM Management**: Video element management in `core/dom-manager.ts`
- **Validation**: Input validation in `core/validation-service.ts`

## Type Definitions

We define various type interfaces to ensure type safety across the application:

- `ButtonState` - Position and visibility state for download buttons
- `DownloadOptions` - Options for video downloads (format, quality, etc.)
- `HistoryEntry` - Stored download history entries
- `ServerConfig` - Server configuration settings
- `Message` - Types for background/content script messaging

## Chrome API Typings

The `global.d.ts` file provides TypeScript types for Chrome extension APIs:

- `chrome.storage` - For saving/loading persistent data
- `chrome.runtime` - For messaging between scripts
- `chrome.tabs` - For accessing browser tabs
- `chrome.action` - For controlling the browser action button

These types make developing with the Chrome extension APIs safer and provide better IDE
autocompletion.

## TypeScript Examples

### Server Port Resolution (Single Source of Truth)

The background uses a single helper to get the server port everywhere:

```typescript
// background.ts
const getEffectiveServerPort = async (): Promise<number | null> => {
  try {
    const cached = await storageService.getPort();
    if (typeof cached === "number" && Number.isFinite(cached)) return cached;
  } catch {}
  try {
    const fallback = getServerPort();
    if (typeof fallback === "number" && Number.isFinite(fallback)) {
      try {
        await storageService.setPort?.(fallback);
      } catch {}
      return fallback;
    }
  } catch {}
  return null;
};
```

Use `getEffectiveServerPort()` instead of reading `getServerPort()` or `storageService.getPort()`
directly. This avoids dual sources.

### Using Core Constants

```typescript
import { getServerPort, getPortRange, UI_CONSTANTS } from "./core/constants";

// Get server port for current environment
const port = getServerPort();

// Get port range for scanning
const [start, end] = getPortRange();

// Use UI constants for consistent styling
const buttonId = `${UI_CONSTANTS.BUTTON_ID_PREFIX}${videoId}`;
```

### State Management

```typescript
import { stateManager } from "./core/state-manager";

// Get current UI state
const state = stateManager.getUIState();

// Update state with new values
stateManager.updateUIState({
  buttonPosition: { x: 100, y: 200 },
  isDragging: false,
});
```

### Error Handling

```typescript
import { errorHandler } from "./core/error-handler";

// Log errors with context
errorHandler.handleError("Failed to download video", {
  url: "https://example.com/video",
  error: new Error("Network timeout"),
});
```

### DOM Management

```typescript
import { domManager } from "./core/dom-manager";

// Find video elements on page
const videos = domManager.findVideoElements();

// Create download button for video
const button = domManager.createDownloadButton(videoElement);
```

#### Recent DOM Migration Progress ✅

The extension has successfully migrated from direct DOM string literals to centralized constants:

- **Constants System**: Extended `core/constants.ts` with comprehensive `DOM_SELECTORS` and
  `CSS_CLASSES`
- **Standardized Access**: Both `popup.ts` and `options.ts` now use `domManager` wrapper and
  constants
- **Test Updates**: All test files updated to use constants instead of string literals
- **Performance**: Cached selector queries and consistent error handling via `domManager`

**Example Usage**:

```typescript
import { DOM_SELECTORS, CSS_CLASSES } from "./core/constants";
import { domManager } from "./core/dom-manager";

// Use constants for selectors
const statusEl = domManager.querySelector(DOM_SELECTORS.STATUS_MESSAGE);

// Use constants for CSS classes
statusEl.className = CSS_CLASSES.STATUS_SUCCESS;
```

### Validation

```typescript
import { validationService } from "./core/validation-service";

// Validate download URL
const isValid = validationService.isValidDownloadUrl(url);

// Validate port number
const isValidPort = validationService.isValidPort(8080);
```

## Current Coverage Status

**Overall Coverage**: 64.18% statements, 48.23% branches

**High Coverage Modules** (>80%):

- `background-helpers.ts`: 92.85% statements
- `background-logic.ts`: 96.55% statements
- `history.ts`: 88.12% statements
- `youtube_enhance.ts`: 100% statements
- `validation-service.ts`: 80.55% statements
- `utils.ts`: 97.43% statements
- `event-manager.ts`: 100% statements
- `performance-utils.ts`: 100% statements

**Modules Needing Coverage** (<80%):

- `background.ts`: 41.19% statements
- `options.ts`: 55.24% statements
- `error-handler.ts`: 41.3% statements
- `logger.ts`: 35.61% statements
- `state-manager.ts`: 46.29% statements
- `content.ts`: 60.45% statements
- `popup.ts`: 71.83% statements
